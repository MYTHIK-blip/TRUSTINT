# TRUSTINT: The Operator's User Guide

Welcome, Steward. This guide provides a complete overview of the TRUSTINT Daemon (TID), its architecture, and how to operate it effectively.

## üìú 1. Core Vision & Principles

TRUSTINT is a **Trust Intelligence Daemon**. Its purpose is not just to store data, but to create a tamper-evident, auditable, and sovereign system for managing trusts, assets, roles, and obligations over generations.

It operates on a few key principles:

*   ‚úÖ **Integrity First**: The system's health and the validity of its data are paramount.
*   ‚úçÔ∏è **Mandatory Provenance**: Every significant action is recorded and cryptographically signed in an append-only ledger. Nothing happens without a record.
*   ‚öôÔ∏è **Deterministic & Idempotent**: The same inputs will always produce the same outputs. Actions can be re-run without causing errors or duplicate data.
*   üèõÔ∏è **Continuity & Stewardship**: The system is designed for long-term resilience, ensuring that the data and the rules governing it can outlive any single operator or piece of hardware.

---

## üèóÔ∏è 2. System Architecture: The Flow of Trust

TRUSTINT operates as a pipeline, moving data from human-readable configuration files to a secure, machine-readable database, and finally to generated reports.

Here is a schematic overview of the data flow:

```
   [You, The Steward]
         |
         v
  üìù CONFIGURATION
  (config/*.yaml)
  - assets.yaml
  - laws.yaml
  - roles.yaml
  - trusts.yaml
         |
         |
         v
  ‚û°Ô∏è INGESTION PIPELINE (trustint ingest)
         |
         |---[ üï∏Ô∏è core/lattice.py ]---> (VALIDATION: Checks rules, e.g., "Does the trust have a trustee?")
         |
         |---[ üèõÔ∏è core/substrate.py ]---> (INGESTION: Loads data into the database)
         |
         |---[ ‚úçÔ∏è utils/provenance.py ]---> (PROVENANCE: Records the 'ingest' event in the ledger)
         |
         v
  üîê THE VAULT (vault/)
  [This is the secure heart of the system]
  |
  |---[ üóÑÔ∏è trustint.db ]       (The SQLite Database: Your data-at-rest)
  |---[ üßæ events.jsonl ]      (The Provenance Ledger: Tamper-evident log of all actions)
  |---[ üîë .hmac_key ]         (The Secret Key: Signs and secures the ledger)
         |
         |
         v
  ‚¨ÖÔ∏è EXPORT PIPELINE (trustint export)
         |
         |---[ üî¢ core/matrices.py ]---> (EXPORT: Reads from the DB and generates reports)
         |
         v
  üì¶ DISTRIBUTED ARTIFACTS (dist/)
  - board_report.md (Human-readable report)
  - trustint_export.csv (Spreadsheet-friendly data)
  - trustint_export.jsonl (Machine-readable data)
  - SHA256SUMS (Checksums to verify report integrity)
```

### The Daemon ü§ñ (`trustint run`)

The daemon automates this entire flow. It watches a directory (`inbox/`) for new files. When a file appears, it can automatically trigger the `validate`, `ingest`, and `export` commands, running the full pipeline from start to finish.

---

## üõ†Ô∏è 3. How to Operate TRUSTINT: A Guide to the CLI

All core operations are performed via the `trustint` command-line interface.

### Initial Setup

Before you begin, ensure the system is ready.

1.  **Install Dependencies**: From the project root, run `make setup`. This creates a virtual environment (`.venv/`) and installs all required packages.
2.  **Key Generation**: The first time you run a command that requires provenance (like `trustint ingest`), the system will automatically generate a secure HMAC key and save it to `vault/.hmac_key`. No manual key generation is needed to get started.

### Core Commands

| Command                                       | What It Does                                                                                                                            |
| :-------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------- |
| `trustint validate`                           | **Checks your `config/` files** for syntax errors and validates them against the system's rules (e.g., every asset must belong to a trust). |
| `trustint ingest`                             | **Loads your `config/` files** into the `vault/trustint.db` database and records this action in the `vault/events.jsonl` provenance ledger. |
| `trustint export`                             | **Generates reports** (Markdown, CSV, JSONL) from the data currently in the database and places them in the `dist/` directory.             |
| `trustint search --scope <scope> "query"`     | **Searches the database** for information. Scopes can be `assets`, `roles`, `trusts`, etc.                                                |
| `trustint doctor`                             | **Performs a full system health check**. This is your most important command for verifying system integrity.                               |
| `trustint run --watch <dir> --on-change <cmds>` | **Starts the daemon**. It watches a directory and runs a sequence of commands (e.g., "validate,ingest,export") when a file is added.       |

### Verifying Integrity (The Doctor ü©∫)

The `trustint doctor` command is your go-to tool for ensuring the system is healthy. It checks:

*   **DB Journal Mode (WAL)**: Ensures the database is in a high-performance mode.
*   **DB Foreign Keys (ON)**: Confirms the database is enforcing data relationships correctly.
*   **FTS5 Available**: Checks that the full-text search engine is working.
*   **Provenance HMAC Key**: Confirms that the secret key for signing the ledger is loaded.
*   **Provenance Chain Verify**: **This is the most critical check.** It walks the entire `events.jsonl` ledger, recalculating the cryptographic signature of each entry to ensure it has not been tampered with. If this fails, your system's integrity is compromised.

---

## üìÇ 4. Directory & File Reference

This provides a quick reference for the project's structure.

*   `config/`: **Source of Truth**. Where you define your trusts, assets, and roles.
*   `core/`: **Application Heart**. The Python code that does the actual work of ingestion, validation, and exporting.
*   `dist/`: **Exported Reports**. All generated reports and data files land here.
*   `docs/`: **Project Documentation**.
*   `inbox/`: **Daemon Watch Folder**. The daemon monitors this directory for new files to process.
*   `migrations/`: **Database Blueprints**. Contains the SQL scripts that define the database structure.
*   `scripts/`: **CLI Entrypoints**. The code that defines the `trustint` command and other useful tools like `prov_tools.py`.
*   `tests/`: **Automated Tests**. Ensures the codebase is stable and reliable.
*   `utils/`: **Shared Tools**. Contains helper code used across the application, such as the logger and the core `provenance.py` logic.
*   `vault/`: **The Secure Vault**. Contains the live database, the secret key, and the all-important provenance ledger. **This is the system's state.**

---

## ü§î 5. Troubleshooting

*   **`ModuleNotFoundError: core`**: This happens when Python can't find the project's source code.
    *   **Solution**: Ensure you have run `make setup` which installs the project in "editable" mode. If running a script directly, prefix the command with `PYTHONPATH=.` (e.g., `PYTHONPATH=. python3 scripts/prov_tools.py ...`).

*   **`trustint: command not found`**: The `trustint` CLI tool isn't in your shell's path.
    *   **Solution**: This also means the project wasn't installed correctly. Run `make setup`. If you want to run it without installing, you can call the script directly: `.venv/bin/trustint`.

*   **`Provenance Chain Verify: FAIL`**: This is a critical error reported by `trustint doctor`.
    *   **Solution**: Your `vault/events.jsonl` ledger is corrupt. You must archive the broken ledger and re-ingest your data to create a new, valid one, as we did earlier.

***

This guide should serve as a solid foundation. We can now look at how to expand the `doctor` command and improve the CLI based on this understanding.
